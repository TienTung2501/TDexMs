Tuyệt vời, chúng ta sẽ "mổ xẻ" chi tiết từng hành động của nhóm **Traders (Người dùng)**. Nhóm này tương tác chủ yếu với `escrow_validator`, `order_validator` và `intent_token_policy`.

Dưới đây là luồng giao dịch (Transaction Flow) chi tiết dưới góc độ của một hệ thống Off-chain Builder (Backend/Client) khi xây dựng giao dịch để người dùng ký.

---

### 1. Tạo Lệnh Swap Cơ bản (Create Swap Intent)

* 
**Mục đích:** Khóa tài sản của người dùng vào một UTxO độc lập (Escrow), kèm theo các điều kiện kỳ vọng (số lượng đổi tối thiểu, hạn chót) để các Solver off-chain tìm đường khớp lệnh.


* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):** Các UTxO từ ví của người dùng. Hệ thống sẽ chọn ra một UTxO cụ thể (`consumed_utxo`) để làm "hạt giống".


* 
**Mints (Đúc Token):** Kích hoạt `intent_token_policy` với redeemer là `MintIntentToken { consumed_utxo }`. Hệ thống sẽ băm (hash) `consumed_utxo` này để tạo ra tên token (Token Name) duy nhất. Số lượng đúc là +1.


* 
**Outputs (Đầu ra):** Tạo 1 UTxO gửi đến địa chỉ của `escrow_validator`. UTxO này chứa:


* 
*Value:* Số lượng tài sản người dùng muốn bán (Input Asset) + 1 Intent Token vừa đúc.


* 
*Datum (Inline):* Khởi tạo `EscrowDatum` chứa thông tin người tạo (`owner`), tài sản bán (`input_asset`), tài sản mua (`output_asset`), số lượng kỳ vọng (`min_output`), hạn chót (`deadline`), và cấu hình cho phép khớp một phần (`max_partial_fills`).




* **Signatures (Chữ ký):** Chữ ký ví của người dùng.


* **Xác thực On-chain (Validator Checks):**
* Chính sách đúc (`intent_token_policy`) sẽ kiểm tra: UTxO "hạt giống" có thực sự bị tiêu thụ trong giao dịch này không ; có đúng 1 token được đúc ra với tên chuẩn xác không ; và token đó có nằm gọn trong địa chỉ của `escrow_validator` không.





### 2. Hủy Lệnh Swap Cơ bản (Cancel Swap Intent)

* 
**Mục đích:** Người dùng đổi ý hoặc lệnh chưa được khớp, họ muốn rút lại toàn bộ số tiền đang khóa.


* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):** UTxO Escrow đang chứa Intent Token và tài sản của người dùng. Cần cung cấp redeemer là `Cancel` cho `escrow_validator`.


* 
**Mints (Đốt Token):** Kích hoạt `intent_token_policy` với redeemer là `BurnIntentToken`. Số lượng đúc là -1 để tiêu hủy token.


* 
**Outputs (Đầu ra):** 1 UTxO trả về địa chỉ của `owner` (người dùng), chứa toàn bộ số tiền chưa được khớp (`remaining_input` của `input_asset`).


* 
**Signatures (Chữ ký):** Chữ ký ví của người dùng (`owner`).




* **Xác thực On-chain (Validator Checks):**
* 
`escrow_validator` kiểm tra: Chữ ký của giao dịch có khớp với `owner_vkh` lưu trong Datum không (`check_signer`).


* Kiểm tra token định danh của Intent đã bị đốt chưa (`check_burn_one`).


* Kiểm tra đầu ra có thanh toán đủ số tiền còn lại (`remaining_input`) về đúng địa chỉ người dùng không (`check_payment_output`).





### 3. Tạo Lệnh Nâng cao (Create Limit / DCA / Stop-Loss Order)

* 
**Mục đích:** Người dùng muốn thiết lập các chiến lược giao dịch dài hạn, chỉ kích hoạt khi đạt điều kiện nhất định về giá hoặc thời gian.


* **Cấu trúc Giao dịch (Tx Builder):**
* Tương tự như tạo Swap Intent, điểm khác biệt là đích đến và Datum.
* 
**Inputs:** Các UTxO từ ví, chọn một `consumed_utxo`.


* 
**Mints:** Kích hoạt `intent_token_policy` để đúc 1 Order Token.


* 
**Outputs:** Tạo 1 UTxO gửi đến địa chỉ của `order_validator`.


* 
*Value:* Toàn bộ ngân sách giao dịch (`remaining_budget`) + 1 Order Token.


* *Datum (Inline):* Khởi tạo `OrderDatum`. Tùy theo loại lệnh mà `order_type` sẽ là `LimitOrder`, `DCA`, hoặc `StopLoss`. Trong `OrderParams` sẽ chứa các thông số chuyên sâu như `target_price_num`, `target_price_den`, `amount_per_interval`.




* **Signatures:** Chữ ký người dùng.



### 4. Hủy Lệnh Nâng cao (Cancel Advanced Order)

* 
**Mục đích:** Người dùng muốn thu hồi phần ngân sách (budget) chưa được thực thi của các lệnh Limit, DCA, hoặc Stop-loss.


* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs:** UTxO Order đang nằm tại `order_validator`. Redeemer là `CancelOrder`.


* 
**Mints:** Kích hoạt `intent_token_policy` để đốt (-1) Order Token.


* 
**Outputs:** 1 UTxO trả về địa chỉ `owner` chứa số tài sản bằng đúng `params.remaining_budget`.


* 
**Signatures:** Chữ ký ví của `owner`.




* **Xác thực On-chain (Validator Checks):**
* 
`order_validator` kiểm tra tương tự như Escrow: Xác thực chữ ký `owner` (`check_signer`), đảm bảo Order Token bị đốt đi (`check_burn_one`), và thanh toán đúng số ngân sách còn lại về ví người dùng (`check_payment_output`).





---

Có thể thấy, đối với người dùng (Traders), mọi thao tác của họ chỉ xoay quanh việc **Tạo ra (Tạo UTxO)** và **Hủy bỏ (Tiêu thụ UTxO của chính mình)**. Họ không bao giờ phải trực tiếp tương tác với các Pool thanh khoản phức tạp, qua đó loại bỏ hoàn toàn rủi ro trượt giá do nghẽn mạng hoặc lỗi tính toán trượt giá từ phía client.

Cảm ơn bạn đã chỉ ra một điểm rất tinh tế! Bạn hoàn toàn đúng khi thắc mắc về hành động `Reclaim` (Thu hồi).

Thực chất, `Reclaim` trong `escrow_validator` là một hành động mang tính chất "lai" (hybrid). Theo thiết kế của hợp đồng, **bất kỳ ai cũng có thể gọi hàm Reclaim** miễn là lệnh đó đã quá hạn (deadline), và hệ thống bắt buộc toàn bộ số tiền phải được trả về cho chủ sở hữu gốc.

Do đó, hành động này hoàn toàn có thể được thực hiện bởi chính **Traders** (người dùng tự dọn dẹp lệnh quá hạn của mình) hoặc bởi **Keepers/Bots** (dọn dẹp mạng lưới giúp người dùng).

Tôi xin bổ sung chi tiết luồng giao dịch này vào nhóm hành động của Người dùng theo đúng định dạng đã phân tích:

### 5. Thu hồi Lệnh Hết hạn (Reclaim Intent)

* 
**Mục đích:** Thu hồi lại toàn bộ tài sản đang khóa trong một lệnh Swap (Escrow) khi lệnh này đã vượt quá thời gian quy định (deadline) mà chưa được khớp xong.


* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):** UTxO Escrow đang chứa Intent Token và tài sản của người dùng. Cần cung cấp redeemer là `Reclaim`.


* 
**Mints (Đốt Token):** Kích hoạt `intent_token_policy` để đốt (-1) Intent Token tương tự như hành động Cancel.


* 
**Outputs (Đầu ra):** 1 UTxO trả về địa chỉ của `owner` (người tạo lệnh ban đầu), chứa toàn bộ số tiền chưa được khớp (`remaining_input` của `input_asset`).


* **Validity Range (Khoảng thời gian hợp lệ):** *Đây là điểm quan trọng nhất*. Giao dịch bắt buộc phải thiết lập dải thời gian (validity range) nằm hoàn toàn ở thời điểm *sau* mốc `deadline` được ghi trong Datum.


* 
**Signatures (Chữ ký):** **Không yêu cầu chữ ký của người dùng.** Bất kỳ ví nào tạo và gửi giao dịch này đều hợp lệ, miễn là thỏa mãn các điều kiện đầu ra.




* **Xác thực On-chain (Validator Checks):**
* 
`check_after_deadline`: Xác kiểm tra dải thời gian hợp lệ của giao dịch thực sự diễn ra sau hạn chót (`datum.deadline`).


* 
`check_burn_one`: Đảm bảo Token định danh (Intent Token) đã bị tiêu hủy.


* 
`check_payment_output`: Đảm bảo toàn bộ số tiền đầu vào còn lại (`datum.remaining_input`) được chuyển chính xác về địa chỉ ví của người dùng (`datum.owner`). Không ai có thể ăn cắp số tiền này dù họ là người khởi tạo giao dịch `Reclaim`.



Sự khác biệt lớn nhất giữa `Cancel` và `Reclaim` là `Cancel` có thể gọi bất cứ lúc nào nhưng bắt buộc phải có chữ ký (dành riêng cho chủ sở hữu) , trong khi `Reclaim` không cần chữ ký nhưng phải đợi đến khi hết hạn.
