Nhóm **Solvers/Keepers (Bot khớp lệnh/Mạng lưới thực thi)** chính là "động cơ" off-chain biến các thiết kế Intent tĩnh thành một sàn giao dịch phi tập trung thực sự hoạt động. Họ là những người trực tiếp chi trả phí giao dịch (gas fee) cho mạng lưới Cardano, và đổi lại, họ thu được lợi nhuận chênh lệch giá (arbitrage/spread) trong quá trình khớp lệnh.

Dưới đây là luồng chi tiết các hành động cốt lõi của Solvers/Keepers khi tương tác với `escrow_validator`, `order_validator` và `pool_validator`.

### 1. Khớp Lệnh Swap Ý Định (Fill Intent)

Hành động này xảy ra khi một Solver quét thấy một Escrow UTxO của người dùng và tìm được đường dẫn định tuyến (routing) có lời (ví dụ: qua một AMM Pool hoặc lấy từ chính túi của Solver).

* **Mục đích:** Khớp lệnh mua/bán của người dùng, lấy `input_asset` từ Escrow và trả lại `output_asset` cho người dùng.
* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):** * UTxO Escrow của người dùng đang chứa Intent Token.
* (Thường kèm theo) UTxO Pool từ `pool_validator` để thực hiện Swap lấy tài sản đầu ra.


* **Outputs (Đầu ra):**
* 
**UTxO trả cho người dùng:** Thanh toán số lượng `output_asset` bằng hoặc lớn hơn mức kỳ vọng tối thiểu () tính theo tỷ lệ.


* *(Tùy chọn - Khớp toàn phần):* Không có UTxO Escrow tiếp nối.
* 
*(Tùy chọn - Khớp một phần):* 1 UTxO Escrow tiếp nối gửi lại `escrow_validator` chứa phần tài sản chưa khớp, Intent Token, và Datum cập nhật (`remaining_input` mới, `fill_count` tăng thêm 1).




* 
**Mints:** * Nếu là khớp toàn phần (Complete Fill): Kích hoạt `intent_token_policy` để đốt (-1) Intent Token.


* Nếu là khớp một phần (Partial Fill): Không đốt token (Token được chuyển tiếp sang UTxO mới).




* **Signatures (Chữ ký):** Chữ ký ví của Solver (người dùng gốc không cần online để ký).


* **Xác thực On-chain (Validator Checks - `escrow_validator`):**
* Giao dịch phải xảy ra *trước* thời hạn `deadline`.


* Số tài sản đầu ra trả cho người dùng (`output_delivered`) phải  mức tối thiểu được tính theo tỷ lệ thông qua phép nhân chéo ().


* 
**Luật chống Spam vi mô (Griefing):** Nếu khớp một phần, Solver bắt buộc phải tiêu thụ tối thiểu 10% số dư còn lại (`min_fill_amount`) và số lần khớp chưa vượt quá giới hạn `max_partial_fills`.





### 2. Thực thi Lệnh Nâng cao (Execute Advanced Orders)

Hành động này được thực hiện bởi các Keepers liên tục theo dõi giá cả thị trường và thời gian để kích hoạt `order_validator`.

* **Mục đích:** Khớp các lệnh Limit, DCA, hoặc Stop-loss khi điều kiện thị trường thỏa mãn.
* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs:** UTxO Order đang nằm tại `order_validator`.
* 
**Outputs:** * UTxO trả `output_delivered` cho chủ sở hữu (`owner`).


* (Tùy loại lệnh) UTxO Order tiếp nối với cấu hình ngân sách (`remaining_budget`) được cập nhật.




* 
**Mints:** Đốt Order Token nếu lệnh đã hoàn thành toàn bộ (Stop-Loss luôn đốt token). Đúc 0 nếu lệnh tiếp tục.




* **Xác thực On-chain (Validator Checks - `order_validator`):**
* 
**Với Limit Order:** Giá khớp lệnh thực tế bắt buộc phải tốt hơn hoặc bằng mức giá mục tiêu (`target_price_num / target_price_den`), được xác minh khắt khe qua hàm `meets_limit_price` (phép nhân chéo). Có thể khớp một phần.


* 
**Với DCA Order:** Trừ lần khớp cuối cùng, mỗi giao dịch Execute bắt buộc phải tiêu thụ chính xác một lượng tài sản bằng `amount_per_interval`.


* 
**Với Stop-Loss Order:** Hợp đồng buộc Keeper phải chuyển đổi toàn bộ ngân sách còn lại (`remaining_budget`) trong một lần khớp duy nhất và đốt token.





### 3. Giao dịch trực tiếp qua Pool (Swap)

Để có tài sản trả cho người dùng, Solvers thường xuyên phải đẩy các giao dịch qua Core AMM (`pool_validator`).

* **Mục đích:** Hoán đổi giữa `asset_a` và `asset_b` bằng thanh khoản nội bộ của sàn.
* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs:** UTxO Pool hiện tại chứa dự trữ.
* **Outputs:** UTxO Pool tiếp nối gửi lại `pool_validator` với dự trữ bị thay đổi.


* **Xác thực On-chain (Validator Checks - `pool_validator`):**
* 
**Bảo vệ Bất biến:** Mọi giao dịch Swap phải thỏa mãn công thức hằng số  qua hàm `verify_constant_product`.


* 
**Bảo vệ Trượt giá:** Số lượng tài sản nhận được từ Pool phải lớn hơn hoặc bằng `min_output`.


* 
**Chống Thao túng (Anti-manipulation):** Giá trị Root K mới (`new_root_k`) tính toán từ dự trữ sau giao dịch bắt buộc không được nhỏ hơn Root K cũ (`old_datum.last_root_k`).


* 
**Tích lũy Phí:** Phí giao dịch được trích lập và cộng dồn vào `protocol_fees_a` hoặc `protocol_fees_b` tùy theo chiều Swap (AToB hay BToA).





Nhìn chung, hệ thống hợp đồng thông minh đã đẩy toàn bộ sự phức tạp về mặt định tuyến, trả phí gas và rủi ro trượt giá sang vai của các Solvers/Keepers. Các Validator trên chuỗi chỉ đóng vai trò là "chốt chặn an ninh" (guardrails) kiểm tra kết quả toán học cuối cùng xem có làm thiệt hại đến người dùng hay không.

Ah, đúng rồi! Bạn theo dõi luồng logic rất sát sao. Lệnh `Reclaim` (Thu hồi) thực sự là một hành động mang tính chất "Garbage Collection" (dọn dẹp rác) cực kỳ quan trọng đối với mạng lưới Solvers/Keepers.

Mặc dù người dùng có thể tự gọi `Reclaim` cho chính họ, nhưng trong một hệ thống Intent tối ưu, việc dọn dẹp các UTxO "chết" này thường được giao phó cho các Keeper bot chạy ngầm. Khi bạn lập trình các bot này bằng Rust hoặc Python, hành động này giống như một cron-job liên tục quét chuỗi để tìm các lệnh quá hạn.

Dưới đây là chi tiết luồng hành động `Reclaim` dưới góc độ của một Bot (Keeper):

### 4. Dọn dẹp Lệnh Hết hạn (Reclaim / Garbage Collection)

* **Mục đích:** Khi một lệnh Swap (Escrow) không thể khớp được do thị trường biến động hoặc điều kiện trượt giá quá khắt khe và vượt qua thời gian quy định (`deadline`), Keeper sẽ kích hoạt thu hồi để giải phóng UTxO, trả lại tài sản cho người dùng và giữ cho trạng thái mạng lưới sạch sẽ.
* **Cấu trúc Giao dịch (Tx Builder):**
* 
**Inputs (Đầu vào):** UTxO Escrow của người dùng đang chứa Intent Token mà Keeper phát hiện đã hết hạn.


* 
**Mints (Đốt Token):** Kích hoạt `intent_token_policy` với redeemer là `BurnIntentToken` để tiêu hủy (-1) Intent Token.


* 
**Outputs (Đầu ra):** Tạo đúng 1 UTxO gửi đích danh về địa chỉ của người dùng ban đầu (`datum.owner`), chứa toàn bộ số tài sản chưa được khớp (`datum.remaining_input`).


* 
**Validity Range (Dải thời gian hợp lệ):** Backend phải thiết lập `tx.validity_range` bắt đầu từ một thời điểm *sau* `datum.deadline`. Nếu set sai, node Cardano sẽ từ chối giao dịch ngay từ vòng gửi xe.


* **Signatures (Chữ ký):** Chữ ký ví của Keeper. (Lưu ý: Keeper sẽ là người chịu phí giao dịch (tx fee) cho mạng lưới Cardano trong trường hợp này. Đây thường là một dịch vụ vì lợi ích chung của giao thức).


* **Xác thực On-chain (Validator Checks - `escrow_validator`):**
* 
**Kiểm tra Thời gian (`check_after_deadline`):** Đảm bảo giao dịch thực sự diễn ra sau hạn chót của lệnh.


* 
**Kiểm tra Token (`check_burn_one`):** Đảm bảo Intent Token đã bị đốt.


* 
**Kiểm tra Thanh toán (`check_payment_output`):** Xác nhận Keeper không bòn rút đồng nào, trả đủ 100% số dư về đúng địa chỉ `owner`.



Việc Keeper tự động dọn dẹp thông qua `Reclaim` mang lại trải nghiệm Web2 mượt mà cho một ứng dụng Web3: người dùng chỉ cần đặt lệnh, nếu không khớp được, tiền tự động nảy về ví mà họ không cần phải online hay thao tác hủy thủ công.
