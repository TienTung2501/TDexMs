Nhóm **Liquidity Providers (Người cung cấp thanh khoản - LPs)** đóng vai trò là "mạch máu" của hệ thống, cung cấp tài sản để các giao dịch Swap có thể diễn ra. Nhóm này không quan tâm đến các UTxO Intent của người dùng mà tương tác trực tiếp với trái tim của AMM: `pool_validator` và chính sách đúc token `lp_token_policy`.

Dưới đây là luồng giao dịch chi tiết cho các hành động của LPs:

### 1. Thêm Thanh khoản (Deposit)

* **Mục đích:** LP nạp một cặp tài sản (Asset A và Asset B) vào Pool để nhận lại LP Token. LP Token này đại diện cho tỷ lệ sở hữu của họ trong Pool và dùng để nhận phần chia từ phí giao dịch sau này.
* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):** * UTxO từ ví của LP chứa số lượng Asset A và Asset B muốn nạp.
* UTxO của Pool hiện tại đang nằm ở địa chỉ `pool_validator`, chứa Pool NFT và dự trữ hiện tại của Pool.




* 
**Mints (Đúc LP Token):** Gọi `lp_token_policy` với redeemer là `MintOrBurnLP { pool_nft, amount }`. Backend sẽ tính toán số lượng `amount` này: nếu là lần nạp đầu tiên, nó dùng công thức khởi tạo `calculate_initial_lp` ; nếu nạp thêm, nó dùng công thức tỷ lệ `calculate_deposit_lp`. Tên của LP Token đúc ra bắt buộc phải trùng khớp 1:1 với tên của Pool NFT.


* **Outputs (Đầu ra):**
* **Continuing Pool UTxO (UTxO Pool tiếp nối):** Gửi lại địa chỉ `pool_validator`. UTxO này phải chứa Pool NFT , số lượng tài sản dự trữ mới (Dự trữ cũ + lượng nạp vào), và một `PoolDatum` được cập nhật: tăng `total_lp_tokens` và cập nhật `last_root_k` mới.


* **UTxO trả về ví LP:** Chứa số lượng LP Token vừa được đúc và tiền thừa (nếu có).


* **Signatures (Chữ ký):** Chữ ký ví của người cung cấp thanh khoản để tiêu thụ tài sản của họ.


* **Xác thực On-chain (Validator Checks):**
* `pool_validator` sẽ kiểm tra cực kỳ khắt khe:
* Hai tài sản nạp vào phải có số lượng dương ().


* 
**Kiểm tra tỷ lệ (Proportional Check):** Trừ lần nạp đầu tiên, các lần nạp sau bắt buộc phải giữ nguyên tỷ lệ tài sản hiện có trong Pool để không làm sai lệch giá ().


* Số lượng LP token đúc ra phải khớp chính xác tuyệt đối với công thức tính toán qua hàm `check_mint_exact`.


* Các trường quan trọng trong Datum (như Pool NFT, cấu hình tài sản, cấu hình phí) không bị thay đổi, phí giao thức tích lũy (`protocol_fees_a`, `protocol_fees_b`) phải được giữ nguyên không bị LP bòn rút.




* 
`lp_token_policy` sẽ kiểm tra: Giao dịch có thực sự gọi đến `pool_validator` không (nhằm ngăn chặn việc tự ý đúc LP token ngoài luồng).





### 2. Rút Thanh khoản (Withdraw)

* **Mục đích:** LP muốn rút lại tài sản của mình (bao gồm cả vốn gốc và phí giao dịch đã nhập vào dự trữ) bằng cách tiêu hủy (đốt) LP Token họ đang giữ.
* **Cấu trúc Giao dịch (Tx Builder):**
* **Inputs (Đầu vào):**
* UTxO từ ví của LP chứa LP Token muốn rút.
* UTxO của Pool hiện tại tại địa chỉ `pool_validator`.




* 
**Mints (Đốt LP Token):** Gọi `lp_token_policy` với redeemer là `MintOrBurnLP { pool_nft, amount }`, trong đó `amount` là số âm (tương ứng với lượng LP Token bị đốt).


* **Outputs (Đầu ra):**
* **Continuing Pool UTxO:** Gửi lại địa chỉ `pool_validator`. UTxO này chứa Pool NFT , số lượng dự trữ đã bị giảm đi (sau khi trả cho LP), và `PoolDatum` cập nhật: giảm `total_lp_tokens` và tính lại `last_root_k`.


* **UTxO trả về ví LP:** Chứa số lượng Asset A và Asset B được chia theo đúng tỷ lệ phần trăm LP Token họ sở hữu so với tổng cung.


* **Signatures (Chữ ký):** Chữ ký của LP để cho phép đốt LP Token trong ví của họ.


* **Xác thực On-chain (Validator Checks):**
* `pool_validator` kiểm tra:
* Lượng LP Token báo đốt phải  và không được vượt quá tổng cung (`total_lp_tokens`) hiện tại.


* Hàm `check_mint_exact` đảm bảo giao dịch thực sự đốt đúng số lượng LP token thông qua policy.


* 
**Kiểm tra chia phần (Proportional Share):** Tài sản Asset A và Asset B bị rút ra khỏi Pool (`withdrawn_a`, `withdrawn_b`) phải khớp chính xác tuyệt đối với phần chia tỷ lệ (`expected_a_out`, `expected_b_out`).


* Sau khi rút, dự trữ còn lại của Pool không được phép là số âm.


* Cập nhật Datum chính xác: trừ đi tổng cung LP token, cập nhật Root K, và giữ nguyên các khoản phí giao thức của Admin.




* Tương tự như lúc nạp, `lp_token_policy` hoạt động như một lớp bảo vệ mỏng (Forwarding Mint), đảm bảo hành động đốt này được sự cho phép của `pool_validator`.



Có thể thấy, thiết kế "Forwarding Mint"  ở đây cực kỳ thông minh. Thay vì viết lại các logic tính toán phức tạp vào Policy đúc token (gây tốn kém kích thước giao dịch và phí gas), tác giả đã đẩy toàn bộ gánh nặng kiểm tra logic toán học (, tính tỷ lệ nạp/rút) về cho `pool_validator`, giúp `lp_token_policy` rất nhẹ và tối ưu.

Chú ý liên quan đến vấn đề tạo pool và quản lý pool và thu phí:
Để trả lời cho những thắc mắc của bạn, chúng ta cần lật lại chính bản phân tích hợp đồng thông minh mà chúng ta đã làm việc trước đó:

1. Sự thật về quyền "Tạo Pool": Ai cũng có thể làm!
Trái với suy nghĩ ban đầu là chỉ Admin mới có quyền mở Pool, bản thiết kế factory_validator.ak của mạng lưới này mang tính chất Permissionless (Không cần cấp phép).

Đúng là ở phần tổng hợp ban đầu nó được xếp vào nhóm Admin, nhưng trong bản phân tích chi tiết, chúng ta đã đính chính lại: Hợp đồng không hề yêu cầu chữ ký của Admin trong hàm validate_create_pool.

Điều này có nghĩa là: Bất kỳ người dùng bình thường nào (đặc biệt là các dev dự án mới, hoặc những người tạo ra meme coin trên Cardano) đều có quyền tự do mang token của họ lên sàn của bạn để tạo một cặp giao dịch mới. Họ chỉ cần bỏ tiền túi ra để cung cấp thanh khoản ban đầu, sắp xếp token đúng chuẩn (A < B), và trả phí mạng lưới.

2. Người tạo Pool có "Quản lý" được Pool đó không?
Câu trả lời là: KHÔNG.
Trong kiến trúc AMM phi tập trung này, một khi Pool được tạo ra, nó trở thành tài sản chung của giao thức.

Người tạo Pool (Creator) thực chất chỉ là người nạp thanh khoản (LP) đầu tiên. Họ nhận về LP Token và sau đó... quản lý số LP Token này trong trang Portfolio hệt như bao người dùng bình thường khác.

Người tạo Pool không có quyền thay đổi phí giao dịch của Pool, không có quyền rút phí giao thức (chỉ Admin mới có quyền CollectFees), và tuyệt đối không có quyền đóng/xóa Pool (chỉ Admin mới có quyền BurnPoolNFT).